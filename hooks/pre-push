#!/bin/bash

# AI Code Review - Pre-push Hook
# 在推送前严格审查所有未推送的提交（会阻拦推送）
# 只审查本次修改的代码（git diff），不审查整个文件

set -e

echo "🚀 AI Code Review - 推送前严格检查..."

# 检查 AI CR 服务是否运行
if ! curl -s http://localhost:8083/health > /dev/null 2>&1; then
    echo "❌ AI Code Review 服务未运行！"
    echo "请先启动服务: cd ai-cr && go run main.go server"
    echo ""
    echo "⚠️  为了代码质量，必须通过 AI 审查才能推送"
    echo "是否强制跳过审查? (输入 FORCE_PUSH 确认)"
    read -r response
    if [[ "$response" != "FORCE_PUSH" ]]; then
        echo "❌ 推送已取消"
        exit 1
    fi
    echo "⚠️  强制推送（未经审查）"
    exit 0
fi

# 获取当前项目的绝对路径
PROJECT_ROOT=$(pwd)

# 获取远程分支
remote="$1"
url="$2"

# 获取当前分支
current_branch=$(git symbolic-ref --short HEAD)

# 获取未推送的提交
unpushed_commits=$(git log origin/$current_branch..$current_branch --oneline 2>/dev/null || git log --oneline -5)

if [ -z "$unpushed_commits" ]; then
    echo "✅ 没有新的提交"
    exit 0
fi

echo "📝 发现未推送的提交:"
echo "$unpushed_commits"
echo ""

# 获取这些提交涉及的文件
changed_files=$(git diff --name-only origin/$current_branch..$current_branch 2>/dev/null || git diff --name-only HEAD~5..HEAD)
code_files=$(echo "$changed_files" | grep -E '\.(go|js|ts|jsx|tsx|py)$' || true)

if [ -z "$code_files" ]; then
    echo "✅ 没有代码文件变更"
    exit 0
fi

echo "📍 项目路径: $PROJECT_ROOT"
echo "📝 变更的文件:"
echo "$code_files"
echo ""

# 获取这些文件的 diff 内容
echo "🔍 获取代码变更..."
DIFF_CONTENT=$(git diff origin/$current_branch..$current_branch 2>/dev/null || git diff HEAD~5..HEAD)

if [ -z "$DIFF_CONTENT" ]; then
    echo "✅ 没有代码变更"
    exit 0
fi

# 限制 diff 长度，避免 token 过多
DIFF_LENGTH=$(echo "$DIFF_CONTENT" | wc -c)
if [ "$DIFF_LENGTH" -gt 50000 ]; then
    echo "⚠️  代码变更过大 ($DIFF_LENGTH 字符)，截取前 50000 字符"
    DIFF_CONTENT=$(echo "$DIFF_CONTENT" | head -c 50000)
    DIFF_CONTENT="${DIFF_CONTENT}\n\n... (diff 过长，已截断)"
fi

echo "📊 代码变更大小: $DIFF_LENGTH 字符"
echo ""

# 审查代码变更
echo "🔍 AI 审查中（只审查本次修改的代码）..."

# 构建审查请求
REQUEST_TEXT="请严格审查以下代码变更，这些代码即将推送到远程仓库。

【重要】只审查下面 diff 中标记为 + 的新增代码和修改的代码，不要审查整个文件。

代码变更（git diff）：
\`\`\`diff
$DIFF_CONTENT
\`\`\`

请重点关注：
1. 安全漏洞（SQL注入、XSS、敏感信息泄露）
2. 严重的逻辑错误和潜在 Bug
3. 性能问题
4. 代码规范问题

如果发现严重问题，请明确标注「严重」或「critical」。"

# 调用 AI CR 服务
REVIEW_RESULT=$(curl -s -X POST http://localhost:8083/api/review \
    -H "Content-Type: application/json" \
    -d "{\"request\": $(echo "$REQUEST_TEXT" | jq -Rs .)}" \
    | jq -r '.review' 2>/dev/null || echo "调用失败")

if [ "$REVIEW_RESULT" = "调用失败" ]; then
    echo "❌ AI 审查失败！"
    echo "是否强制推送? (输入 FORCE_PUSH 确认)"
    read -r response
    if [[ "$response" != "FORCE_PUSH" ]]; then
        echo "❌ 推送已取消"
        exit 1
    fi
    exit 0
fi

echo ""
echo "📋 AI 审查结果:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "$REVIEW_RESULT"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# 检查是否有严重问题（严格模式）
if echo "$REVIEW_RESULT" | grep -qi "严重\|critical\|security\|安全\|漏洞\|bug"; then
    echo "❌ 发现严重问题，不允许推送！"
    echo ""
    echo "请修复以上问题后再推送。"
    echo ""
    echo "如果确认要强制推送，请输入: FORCE_PUSH"
    read -r response
    if [[ "$response" != "FORCE_PUSH" ]]; then
        echo "❌ 推送已取消"
        exit 1
    fi
    echo "⚠️  强制推送（存在严重问题）"
fi

echo "✅ AI 审查通过，允许推送"
exit 0
