#!/bin/bash

# AI Code Review - Pre-push Hook
# 在推送前严格审查所有未推送的提交（会阻拦推送）
# 只审查本次修改的代码（git diff），不审查整个文件

set -e

echo "🚀 AI Code Review - 推送前严格检查..."

# 检查 AI CR 服务是否运行
if ! curl -s http://localhost:8083/health > /dev/null 2>&1; then
    echo "❌ AI Code Review 服务未运行！"
    echo "请先启动服务: cd ai-cr && go run main.go server"
    echo ""
    echo "⚠️  为了代码质量，必须通过 AI 审查才能推送"
    echo "是否强制跳过审查? (输入 FORCE_PUSH 确认)"
    read -r response
    if [[ "$response" != "FORCE_PUSH" ]]; then
        echo "❌ 推送已取消"
        exit 1
    fi
    echo "⚠️  强制推送（未经审查）"
    exit 0
fi

# 获取当前项目的绝对路径
PROJECT_ROOT=$(pwd)

# 获取远程分支
remote="$1"
url="$2"

# 获取当前分支
current_branch=$(git symbolic-ref --short HEAD)

# 获取未推送的提交
unpushed_commits=$(git log origin/$current_branch..$current_branch --oneline 2>/dev/null || git log --oneline -5)

if [ -z "$unpushed_commits" ]; then
    echo "✅ 没有新的提交"
    exit 0
fi

echo "📝 发现未推送的提交:"
echo "$unpushed_commits"
echo ""

# 获取这些提交涉及的文件
changed_files=$(git diff --name-only origin/$current_branch..$current_branch 2>/dev/null || git diff --name-only HEAD~5..HEAD)
code_files=$(echo "$changed_files" | grep -E '\.(go|js|ts|jsx|tsx|py)$' || true)

if [ -z "$code_files" ]; then
    echo "✅ 没有代码文件变更"
    exit 0
fi

echo "📍 项目路径: $PROJECT_ROOT"
echo "📝 变更的文件:"
echo "$code_files"
echo ""

# 获取这些文件的 diff 内容
echo "🔍 获取代码变更..."
DIFF_CONTENT=$(git diff origin/$current_branch..$current_branch 2>/dev/null || git diff HEAD~5..HEAD)

if [ -z "$DIFF_CONTENT" ]; then
    echo "✅ 没有代码变更"
    exit 0
fi

# 限制 diff 长度，避免 token 过多
DIFF_LENGTH=$(echo "$DIFF_CONTENT" | wc -c)
if [ "$DIFF_LENGTH" -gt 50000 ]; then
    echo "⚠️  代码变更过大 ($DIFF_LENGTH 字符)，截取前 50000 字符"
    DIFF_CONTENT=$(echo "$DIFF_CONTENT" | head -c 50000)
    DIFF_CONTENT="${DIFF_CONTENT}\n\n... (diff 过长，已截断)"
fi

echo "📊 代码变更大小: $DIFF_LENGTH 字符"
echo ""

# 分析 diff：统计新增和删除的代码行
ADDED_LINES=$(echo "$DIFF_CONTENT" | grep -E '^\+[^+]' | wc -l | tr -d ' ')
DELETED_LINES=$(echo "$DIFF_CONTENT" | grep -E '^-[^-]' | wc -l | tr -d ' ')

echo "� 代码变更统计:"
echo "  ➕ 新增: $ADDED_LINES 行"
echo "  ➖ 删除: $DELETED_LINES 行"
echo ""

# 如果只有删除没有新增，直接放行（删除代码通常是安全的）
if [ "$ADDED_LINES" -eq 0 ] && [ "$DELETED_LINES" -gt 0 ]; then
    echo "✅ 本次变更只删除代码，无需审查"
    echo "✅ 允许推送"
    exit 0
fi

# 审查代码变更
echo "🔍 AI 审查中（只审查本次修改的代码）..."

# 构建审查请求
REQUEST_TEXT="请严格审查以下代码变更，这些代码即将推送到远程仓库。

【代码变更统计】
- 新增: $ADDED_LINES 行
- 删除: $DELETED_LINES 行

【重要】只审查下面 diff 中标记为 + 的新增代码，不要审查删除的代码（- 开头的行）。

代码变更（git diff）：
\`\`\`diff
$DIFF_CONTENT
\`\`\`

请重点关注：
1. 安全漏洞（SQL注入、XSS、敏感信息泄露）
2. 严重的逻辑错误和潜在 Bug
3. 性能问题
4. 代码规范问题

如果新增的代码没有问题，请明确回复「✅ 通过」或「✅ 可以推送」。
如果发现严重问题，请明确标注「❌ 严重问题」。"

# 调用 AI CR 服务
REVIEW_RESULT=$(curl -s -X POST http://localhost:8083/api/review \
    -H "Content-Type: application/json" \
    -d "{\"request\": $(echo "$REQUEST_TEXT" | jq -Rs .)}" \
    | jq -r '.review' 2>/dev/null || echo "调用失败")

if [ "$REVIEW_RESULT" = "调用失败" ]; then
    echo "❌ AI 审查失败！"
    echo "是否强制推送? (输入 FORCE_PUSH 确认)"
    read -r response
    if [[ "$response" != "FORCE_PUSH" ]]; then
        echo "❌ 推送已取消"
        exit 1
    fi
    exit 0
fi

echo ""
echo "📋 AI 审查结果:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "$REVIEW_RESULT"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# 智能判断：优先检查是否通过
# 1. 如果 AI 明确说"通过"或"接受"，直接放行
if echo "$REVIEW_RESULT" | grep -Eq "✅.*(通过|接受|允许|可以推送)|审查.*通过|建议.*接受|这个变更.*应该.*接受|这是.*正面.*修复|这是.*好的.*变更"; then
    echo "✅ AI 审查通过，允许推送"
    exit 0
fi

# 2. 如果包含"删除"、"移除"、"修复"等正面词汇，且提到"危险"、"漏洞"，说明是修复问题
if echo "$REVIEW_RESULT" | grep -Eq "(删除|移除|修复|消除).*(危险|漏洞|风险|问题)"; then
    echo "✅ AI 识别到这是一个修复问题的变更"
    echo "✅ AI 审查通过，允许推送"
    exit 0
fi

# 3. 检查是否有严重问题（且不是修复）
if echo "$REVIEW_RESULT" | grep -Eq "严重|critical|❌|不允许|不建议|阻止"; then
    echo "❌ 发现严重问题，不允许推送！"
    echo ""
    echo "请修复以上问题后再推送。"
    echo ""
    echo "如果确认要强制推送，请输入: FORCE_PUSH"
    read -r response
    if [[ "$response" != "FORCE_PUSH" ]]; then
        echo "❌ 推送已取消"
        exit 1
    fi
    echo "⚠️  强制推送（存在严重问题）"
fi

echo "✅ AI 审查通过，允许推送"
exit 0
